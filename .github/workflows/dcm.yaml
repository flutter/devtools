# A CI workflow to run the Dart Code Metrics analyzer (https://dcm.dev).

# NOTE: DCM usage in DevTools is currently experimental! 

# The DCM_CI_KEY and DCM_EMAIL secrets are set in the admin settings page
# of the flutter/devtools repo. They can be found at: go/dash-devexp-dcm-keys
# These are associated with a trial license of DCM, and will need to be changed
# if we decide to purchase an actual license. The trial license will expire on
# April 11, 2024.

# If you want to install and run DCM locally, please refer to CONTRIBUTING.md
# for instructions.

name: Dart Code Metrics

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  dcm:
    name: Dart Code Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Install DCM
        run: |
          sudo apt-get update
          wget -qO- https://dcm.dev/pgp-key.public | sudo gpg --dearmor -o /usr/share/keyrings/dcm.gpg
          echo 'deb [signed-by=/usr/share/keyrings/dcm.gpg arch=amd64] https://dcm.dev/debian stable main' | sudo tee /etc/apt/sources.list.d/dart_stable.list
          sudo apt-get update
          sudo apt-get install dcm
          sudo chmod +x /usr/bin/dcm
      - name: Checkout repository
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b
      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@6a218f2413a3e78e9087f638a238f6b40893203d
      - name: Run DCM on root
        run: |
          dcm analyze --ci-key="${{ secrets.DCM_CI_KEY }}" --email="${{ secrets.DCM_EMAIL }}" .
