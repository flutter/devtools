# Copyright 2020 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

name: devtools

on:
  pull_request:
  push:
    branches:
      - master

# Declare default permissions as read only.
permissions: read-all

env:
  AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  ubuntu-flutter-prep:
    name: Ubuntu Flutter Prep
    runs-on: ubuntu-latest 
    #TODO can this be matrixed on OS.
    outputs:
      latest_flutter_candidate: ${{ steps.flutter-candidate.outputs.FLUTTER_CANDIDATE }}
    steps:
      - name: git clone devtools
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
      - name: Get Latest Flutter Candidate
        id: flutter-candidate
        run: |
          ./tool/latest_flutter_candidate.sh
          LATEST_FLUTTER_CANDIDATE=$(./tool/latest_flutter_candidate.sh)
          echo $LATEST_FLUTTER_CANDIDATE
          if [ -z ${LATEST_FLUTTER_CANDIDATE+x} ]; then
            echo "::error ::Unable to get Latest flutter candidate"
            exit 1
          fi
          echo "FLUTTER_CANDIDATE=$LATEST_FLUTTER_CANDIDATE" >> $GITHUB_OUTPUT
          
      - name: Load Cached Flutter SDK
        uses: actions/cache@v3
        with:
          path: |
            ./flutter-sdk
          key: flutter-sdk-${{ runner.os }}-${{ steps.flutter-candidate.outputs.FLUTTER_CANDIDATE }}

      - name: Clone Flutter SDK if none cached
        run: |
          if [ ! -d "./flutter-sdk" ]; then
            git clone https://github.com/flutter/flutter.git ./flutter-sdk
            cd flutter-sdk
            git checkout $LATEST_FLUTTER_CANDIDATE
          fi
        env:
          FLUTTER_HEAD_SHA: ${{ steps.get-flutter-head.outputs.SHA }}

      - name: Setup Flutter SDK
        run: |
          ./flutter-sdk/bin/flutter config --no-analytics
          ./flutter-sdk/bin/cache/dart-sdk/bin/dart --disable-analytics

  main:
    name: main
    needs: ubuntu-flutter-prep
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: git clone
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
      - name: Load Cached Flutter SDK
        uses: actions/cache@v3
        with:
          path: |
            ./flutter-sdk
          key: flutter-sdk-${{ runner.os }}-${{ needs.ubuntu-flutter-prep.outputs.latest_flutter_candidate }} 

      - name: Cache Generated Files
        uses: actions/cache@v3
        with:
          path: |
            **/build/
            **/.dart_tool/
            ./flutter-sdk
          key: ${{ runner.os }}-cache
      - name: tool/bots.sh
        env:
          BOT: main
        run: ./tool/bots.sh

  # test:
  #   name: test ${{ matrix.bot }}
  #   runs-on: ubuntu-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       bot:
  #         - test_ddc
  #         - test_dart2js
  #   steps:
  #     - name: git clone
  #       uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
  #     - name: Cache Generated Files
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           **/build/
  #           **/.dart_tool/
  #           ./flutter-sdk
  #         key: ${{ runner.os }}-cache
  #     - name: tool/bots.sh
  #       env:
  #         BOT: ${{ matrix.bot }}
  #         PLATFORM: vm
  #       run: ./tool/bots.sh

  #     - name: image failures
  #       uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8
  #       if: failure() # Only if failure then failures directory exists.
  #       with:
  #         # TODO(terry): matrix.os currently empty. If we run tests on other
  #         #              platforms this will be used.
  #         name: test-image-failures-${{ matrix.os }} # Name for the artifact
  #         path: packages/devtools_app/test/failures # Path to upload
                
  # macos-test:
  #   name: macos ${{ matrix.bot }}
  #   runs-on: macos-latest
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       bot:
  #         - test_dart2js
  #   steps:
  #     - name: git clone
  #       uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
  #     - name: Cache Generated Files
  #       uses: actions/cache@v3
  #       with:
  #         path: |
  #           **/build/
  #           **/.dart_tool/
  #           ./flutter-sdk
  #         key: ${{ runner.os }}-cache
  #     - name: tool/bots.sh
  #       env:
  #         BOT: ${{ matrix.bot }}
  #         PLATFORM: vm
  #       run: ./tool/bots.sh
  
  #     - name: Upload Golden Failure Artifacts
  #       uses: actions/upload-artifact@v3
  #       if: failure()
  #       with: 
  #         name: golden_image_failures.${{ matrix.bot }}
  #         path: packages/devtools_app/test/**/failures/*.png


# TODO(https://github.com/flutter/devtools/issues/1715): add a windows compatible version of tool/bots.sh
# and run it from this job.
#  windows-test:
#    name: windows ${{ matrix.bot }}
#    runs-on: windows-latest
#    strategy:
#      fail-fast: false
#      matrix:
#        bot:
#          - test_dart2js
#    steps:
#      - name: git clone
#        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
#
#      - name: tool/bots.sh
#        env:
#          BOT: ${{ matrix.bot }}
#          PLATFORM: vm
#        run: ./tool/bots.sh

# TODO(https://github.com/flutter/devtools/issues/1987): rewrite integration tests.
#  integration:
#    name: integration ${{ matrix.bot }}
#    runs-on: ubuntu-latest
#    strategy:
#      fail-fast: false
#      matrix:
#        bot:
#          - integration_ddc
#          - integration_dart2js
#    steps:
#      - name: git clone
#        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
#      - name: tool/bots.sh
#        env:
#          BOT: ${{ matrix.bot }}
#        run: ./tool/bots.sh

# TODO(https://github.com/flutter/devtools/issues/2437):
# PLATFORM=chrome is going away. We need to move these tests to run with
# chromedriver.
#    - BOT=test_ddc            PLATFORM=chrome
# PLATFORM=chrome is going away. We need to move these tests to run with
# chromedriver.
#   - BOT=test_dart2js        PLATFORM=chrome

